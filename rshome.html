<!DOCTYPE html>
<html lang="en">
<head>
    <!-- SECURITY SCRIPT -->
    <script>
        if(localStorage.getItem('isResellerLoggedIn') !== 'true') {
            window.location.href = 'rslogin.html';
        }
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glitzy Gifts | Reseller Hub</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- PDF Generator Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* BASE STYLES */
        :root { --primary-color: #ff4757; --secondary-color: #2f3542; --accent-green: #2ecc71; --accent-orange: #ff9f43; --bg-color: #f1f2f6; --card-bg: #ffffff; --text-color: #2f3542; --input-bg: #f8f9fa; --shadow: 0 4px 15px rgba(0,0,0,0.05); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); color: var(--text-color); padding-bottom: 90px; height: 100vh; overflow-y: auto; }
        .hide { display: none !important; }
        .show { display: block !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        header { background: var(--card-bg); padding: 15px 5%; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.3rem; font-weight: 800; color: var(--primary-color); text-decoration: none; letter-spacing: 1px; }
        .wallet-badge { background: rgba(46, 204, 113, 0.1); color: var(--accent-green); padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 12px; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(46, 204, 113, 0.2); cursor: pointer; }
        
        /* DASHBOARD & GRID */
        .dashboard-stats { margin: 20px 5% 0; padding: 20px; background: var(--secondary-color); color: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(47, 53, 66, 0.2); position: relative; overflow: hidden; }
        .dashboard-stats::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 10%, transparent 10%); background-size: 20px 20px; opacity: 0.3; pointer-events: none; }
        .ds-header { font-size: 13px; font-weight: 600; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; display: flex; justify-content: space-between; }
        .ds-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; row-gap: 20px; }
        .ds-item { display: flex; flex-direction: column; }
        .ds-item .val { font-size: 18px; font-weight: 700; display: block; line-height: 1.2; }
        .ds-item .lbl { font-size: 11px; opacity: 0.7; }
        .view-section { padding-bottom: 20px; }
        .reseller-grid { padding: 20px 5%; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .r-card { background: var(--card-bg); border-radius: 15px; overflow: hidden; box-shadow: var(--shadow); position: relative; transition: 0.3s; cursor: pointer; }
        .r-card:active { transform: scale(0.98); }
        .r-img-container { height: 160px; overflow: hidden; position: relative; }
        .r-img-container img { width: 100%; height: 100%; object-fit: cover; }
        .profit-badge { position: absolute; top: 8px; left: 8px; background: var(--accent-green); color: white; padding: 4px 8px; border-radius: 5px; font-size: 10px; font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        /* NEW STOCK STYLES */
        .stock-badge { position: absolute; bottom: 8px; right: 8px; font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .in-stock { background: #d4edda; color: #155724; }
        .low-stock { background: #fff3cd; color: #856404; }
        .out-stock { background: #f8d7da; color: #721c24; }
        .pd-stock-line { margin: 15px 0 5px 0; padding: 10px; background: #e8f5e9; border-left: 5px solid #2ecc71; color: #1b5e20; font-size: 13px; font-weight: 600; border-radius: 4px; display: flex; align-items: center; gap: 8px; }

        .r-info { padding: 10px; }
        .r-title { font-size: 13px; font-weight: 600; margin-bottom: 5px; height: 38px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .price-row { display: flex; justify-content: space-between; align-items: center; }
        .wholesale { color: var(--primary-color); font-weight: 700; font-size: 14px; }
        .rrp { text-decoration: line-through; color: #aaa; font-size: 11px; }
        
        /* PRODUCT DETAILS */
        .pd-header { position: absolute; top: 15px; left: 15px; z-index: 100; }
        .back-btn { background: rgba(255,255,255,0.9); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--secondary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pd-image-area { background: #fff; padding-bottom: 10px; }
        .product-img-full { width: 100%; height: 350px; object-fit: cover; transition: 0.3s; }
        .thumb-list { display: flex; gap: 10px; padding: 0 15px; overflow-x: auto; margin-top: -30px; position: relative; z-index: 50; }
        .thumb-item { width: 60px; height: 60px; border-radius: 10px; border: 2px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.2); overflow: hidden; flex-shrink: 0; cursor: pointer; transition: 0.2s; }
        .thumb-item.active { border-color: var(--primary-color); transform: scale(1.1); }
        .thumb-item img { width: 100%; height: 100%; object-fit: cover; }
        .download-btn { position: absolute; top: 15px; right: 15px; z-index: 100; background: rgba(0,0,0,0.6); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .pd-container { background: var(--card-bg); border-radius: 30px 30px 0 0; margin-top: 15px; padding: 25px; position: relative; min-height: 400px; box-shadow: 0 -5px 15px rgba(0,0,0,0.05); }
        .pd-title { font-size: 20px; font-weight: 700; color: var(--secondary-color); line-height: 1.3; }
        .price-card { background: #f8f9fa; border-radius: 15px; padding: 15px; margin: 20px 0 10px 0; display: flex; justify-content: space-between; border: 1px solid #eee; }
        .price-block label { font-size: 11px; color: #777; display: block; margin-bottom: 2px; }
        .price-block span { font-size: 18px; font-weight: 700; color: var(--secondary-color); }
        .price-block .profit { color: var(--accent-green); }
        .desc-text { font-size: 13px; color: #666; line-height: 1.6; margin-top: 10px; white-space: pre-line; }
        .variant-box { margin-top: 15px; }
        .variant-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; outline: none; margin-top: 5px; }
        .admin-contact-box { background: rgba(47, 53, 66, 0.05); border-left: 4px solid var(--secondary-color); padding: 15px; border-radius: 8px; margin-top: 25px; display: flex; align-items: center; gap: 15px; }
        .admin-icon { width: 40px; height: 40px; background: var(--secondary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .action-bar { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); padding: 15px 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); display: flex; gap: 15px; z-index: 2000; }
        .btn { flex: 1; padding: 12px; border-radius: 10px; font-weight: 600; border: none; cursor: pointer; font-size: 14px; }
        .btn-copy { background: #eee; color: var(--secondary-color); }
        .btn-buy { background: var(--primary-color); color: white; }
        
        /* ORDERS LIST & ACTIONS */
        .page-header { background: var(--card-bg); padding: 20px; text-align: center; font-weight: 700; font-size: 18px; box-shadow: var(--shadow); margin-bottom: 15px; }
        .order-list { padding: 0 20px; display: flex; flex-direction: column; gap: 15px; }
        .order-card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: var(--shadow); border-left: 4px solid transparent; position: relative; }
        .order-card-content { cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .order-actions { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; display: flex; justify-content: flex-end; gap: 10px; }
        .act-btn { padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; border: none; display: flex; align-items: center; gap: 5px; }
        .btn-edit { background: #f1f2f6; color: var(--secondary-color); }
        .btn-cancel { background: #ffe0e3; color: #c0392b; }
        .btn-invoice { background: #e3f2fd; color: #2980b9; }

        .order-card.pending { border-left-color: #f1c40f; }
        .order-card.delivered { border-left-color: #2ecc71; }
        .order-card.cancelled { border-left-color: #ff4757; }
        .o-id { font-size: 14px; font-weight: 600; color: var(--secondary-color); }
        .o-date { font-size: 11px; color: #888; margin-top: 3px; }
        .o-status { font-size: 10px; padding: 4px 8px; border-radius: 4px; font-weight: 600; text-transform: uppercase; }
        .st-pending { background: #fff3cd; color: #856404; }
        .st-delivered { background: #d4edda; color: #155724; }
        .st-cancelled { background: #ffe0e3; color: #c0392b; }
        
        /* WALLET & PROFILE */
        .wallet-header { background: var(--primary-color); padding: 30px 20px 50px; color: white; border-radius: 0 0 30px 30px; text-align: center; margin-bottom: 20px; }
        .w-balance { font-size: 36px; font-weight: 700; margin-top: 5px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 20px; margin-top: -35px; }
        .stat-box { background: var(--card-bg); padding: 15px; border-radius: 15px; text-align: center; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: center; }
        .sb-val { font-size: 18px; font-weight: 700; color: var(--secondary-color); }
        .sb-label { font-size: 11px; color: #777; margin-top: 2px; }
        .withdraw-section { padding: 25px 20px; }
        .withdraw-btn { width: 100%; background: var(--secondary-color); color: white; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 5px 15px rgba(47, 53, 66, 0.3); transition: 0.3s; }
        .withdraw-btn:active { transform: scale(0.98); }
        .history-section { padding: 0 20px 20px; }
        .h-title { font-weight: 700; color: var(--secondary-color); margin-bottom: 15px; font-size: 15px; }
        .history-card { background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .h-left { display: flex; flex-direction: column; }
        .h-type { font-weight: 600; font-size: 13px; color: var(--secondary-color); }
        .h-date { font-size: 10px; color: #999; margin-top: 2px; }
        .h-amount { font-weight: 700; font-size: 14px; }
        .h-status { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
        .profile-header { display: flex; flex-direction: column; align-items: center; padding: 40px 20px; background: var(--card-bg); margin-bottom: 15px; }
        .p-img-wrapper { position: relative; margin-bottom: 15px; }
        .p-img { width: 80px; height: 80px; border-radius: 50%; background: #eee; object-fit: cover; border: 3px solid #f1f2f6; }
        .p-name { font-size: 18px; font-weight: 700; }
        .p-rank { font-size: 12px; background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 10px; margin-top: 5px; font-weight: 600; }
        .p-menu { background: var(--card-bg); padding: 0 20px; }
        .p-item { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f1f1; color: var(--secondary-color); cursor: pointer; }
        .p-item i { width: 30px; color: var(--primary-color); }
        .p-item span { flex: 1; font-size: 14px; font-weight: 500; }
        
        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: #fff; width: 92%; max-width: 420px; padding: 25px; border-radius: 20px; animation: popUp 0.3s; position: relative; max-height: 90vh; overflow-y: auto; }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .m-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; color: var(--secondary-color); display: flex; align-items: center; gap: 8px; }
        .close-modal { position: absolute; top: 20px; right: 20px; font-size: 20px; cursor: pointer; color: #999; padding: 5px; }
        .input-group { position: relative; margin-bottom: 15px; }
        .input-icon { position: absolute; top: 50%; left: 15px; transform: translateY(-50%); color: #888; font-size: 14px; }
        .form-control { width: 100%; padding: 14px 14px 14px 40px; border: 1px solid #eee; background: var(--input-bg); border-radius: 10px; outline: none; font-size: 14px; transition: 0.3s; color: var(--text-color); }
        .form-control:focus { border-color: var(--primary-color); background: #fff; box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1); }
        .form-label { display: block; font-size: 12px; font-weight: 600; color: #555; margin-bottom: 6px; margin-left: 2px; }
        .delivery-options { display: flex; gap: 10px; margin-bottom: 15px; }
        .d-opt { flex: 1; background: var(--input-bg); padding: 12px; border-radius: 10px; border: 1px solid #eee; cursor: pointer; text-align: center; transition: 0.2s; position: relative; overflow: hidden; }
        .d-opt input { display: none; }
        .d-opt.selected { border-color: var(--primary-color); background: rgba(255, 71, 87, 0.05); color: var(--primary-color); font-weight: 600; }
        .d-opt .check { display: none; position: absolute; top: 5px; right: 5px; font-size: 10px; }
        .d-opt.selected .check { display: block; }
        .modal-btn { width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 10px; font-weight: 600; font-size: 15px; margin-top: 10px; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3); transition: 0.2s; }
        .modal-btn:active { transform: scale(0.98); }
        .m-row { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 13px; color: #555; }
        .m-total { font-weight: 700; font-size: 16px; color: var(--secondary-color); margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; border-top: 1px solid #f5f5f5; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #a0a0a0; text-decoration: none; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--primary-color); transform: translateY(-2px); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; }
        #toast { visibility: hidden; min-width: 250px; background-color: var(--secondary-color); color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 4000; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 13px; opacity: 0; transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; opacity: 1; bottom: 90px; }

        /* --- PROFESSIONAL INVOICE STYLES --- */
        #invoice-preview-area { background: white; width: 100%; padding: 20px; box-shadow: 0 0 15px rgba(0,0,0,0.1); font-family: 'Helvetica', sans-serif; position: relative; margin-bottom: 15px; }
        .inv-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #ff4757; padding-bottom: 15px; margin-bottom: 20px; }
        .inv-brand { font-size: 24px; font-weight: 800; color: #ff4757; letter-spacing: 1px; }
        .inv-tagline { font-size: 10px; color: #777; letter-spacing: 2px; text-transform: uppercase; margin-top: 5px; }
        .inv-title { font-size: 22px; font-weight: 700; color: #333; text-transform: uppercase; letter-spacing: 1px; }
        .inv-grid { display: flex; justify-content: space-between; margin-bottom: 30px; gap: 20px; }
        .inv-col h4 { font-size: 10px; color: #999; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 0.5px; }
        .inv-col p { font-size: 12px; font-weight: 600; color: #333; line-height: 1.4; margin: 0; }
        .inv-table-wrapper { border: 1px solid #eee; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .inv-table { width: 100%; border-collapse: collapse; }
        .inv-table th { background: #f8f9fa; color: #555; font-size: 11px; padding: 12px; text-align: left; font-weight: 700; text-transform: uppercase; }
        .inv-table td { padding: 12px; border-bottom: 1px solid #f1f1f1; font-size: 12px; color: #333; }
        .inv-table td:last-child { text-align: right; font-weight: 600; }
        .inv-summary { width: 100%; display: flex; flex-direction: column; align-items: flex-end; }
        .inv-sum-row { display: flex; justify-content: space-between; width: 180px; margin-bottom: 5px; font-size: 12px; color: #555; }
        .inv-total { border-top: 2px solid #eee; padding-top: 10px; margin-top: 5px; font-size: 16px; font-weight: 800; color: #ff4757; }
        .inv-status { margin-top: 20px; padding: 8px 20px; border: 2px solid; font-weight: 700; text-transform: uppercase; font-size: 14px; letter-spacing: 2px; transform: rotate(-5deg); display: inline-block; }
        .status-paid { color: #2ecc71; border-color: #2ecc71; }
        .status-due { color: #ff4757; border-color: #ff4757; }
        .inv-footer { text-align: center; font-size: 10px; color: #aaa; margin-top: 30px; border-top: 1px solid #eee; padding-top: 15px; }
    </style>
</head>
<body>

    <!-- ================= VIEW: HOME ================= -->
    <div id="view-home" class="view-section fade-in">
        <header>
            <div style="display:flex; align-items:center;">
                <a href="#" class="logo">GLITZY GIFTS</a>
                <a href="index.html" style="margin-left:15px; font-size:10px; background:#f1f2f6; padding:5px 10px; border-radius:15px; text-decoration:none; color:#333; font-weight:600;"><i class="fas fa-external-link-alt"></i> Web</a>
            </div>
            <div class="wallet-badge" onclick="switchView('view-wallet', 'nav-wallet')">
                <i class="fas fa-wallet"></i> <span id="header-balance">à§³0</span>
            </div>
        </header>

        <div class="dashboard-stats">
            <div class="ds-header"> 
                <span><i class="fas fa-chart-pie"></i> Analysis Report</span>
                <span style="font-size:10px; background:rgba(255,255,255,0.2); padding:2px 8px; border-radius:10px;">Lifetime</span>
            </div>
            <div class="ds-grid">
                <div class="ds-item"><span class="val" style="color: #2ecc71;" id="ds-completed">0</span><span class="lbl">Completed Orders</span></div>
                <div class="ds-item"><span class="val" style="color: #ff4757;" id="ds-cancelled">0</span><span class="lbl">Cancelled</span></div>
                <div class="ds-item"><span class="val" id="ds-sell">à§³0</span><span class="lbl">Total Sell</span></div>
                <div class="ds-item"><span class="val" style="color: #f1c40f;" id="ds-rank">Member</span><span class="lbl">Member Rank</span></div>
            </div>
        </div>

        <div style="padding: 20px 5% 0; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 700; color: var(--secondary-color);">Featured Items</span>
            <span style="font-size: 12px; color: var(--primary-color);">View All</span>
        </div>

        <div class="reseller-grid" id="product-grid"></div>
    </div>

    <!-- VIEW: PRODUCT DETAILS -->
    <div id="view-details" class="view-section hide">
        <div class="pd-header"><div class="back-btn" onclick="switchView('view-home', 'nav-home')"><i class="fas fa-arrow-left"></i></div></div>
        <div class="pd-image-area">
            <div class="download-btn" onclick="downloadImage()"><i class="fas fa-download"></i></div>
            <img src="" id="d-main-img" class="product-img-full" alt="Product">
            <div class="thumb-list" id="d-thumbs"></div>
        </div>
        <div class="pd-container">
            <h1 class="pd-title" id="d-name">Product Name</h1>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">SKU: <span id="d-sku">GG-001</span></div>
            
            <div class="pd-stock-line" id="d-stock-display">
                <i class="fas fa-check-circle"></i> In Stock: <span id="d-stock-count">0</span> Units
            </div>

            <div class="price-card">
                <div class="price-block"><label>Wholesale Price</label><span id="d-wholesale">à§³0</span></div>
                <div class="price-block" style="text-align: right;"><label>Min Selling Price</label><span class="profit" id="d-rrp" style="color:#aaa; text-decoration: line-through;">à§³0</span></div>
            </div>
            
            <div class="variant-box">
                <label style="font-size:12px; font-weight:600; color:#555;">Select Size/Variant</label>
                <select id="d-variant-select" class="variant-select">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div style="font-weight: 600; margin-bottom: 5px; margin-top: 15px;">Description</div>
            <p class="desc-text" id="d-desc">Description loading...</p>

            <div class="admin-contact-box">
                <div class="admin-icon"><i class="fas fa-headset"></i></div>
                <div>
                    <div style="font-size:11px; color:#777;">Admin Contact</div>
                    <div style="font-weight:700; color:var(--secondary-color)" id="admin-name-display">Support</div>
                    <div style="font-size:12px; font-weight:500"><i class="fas fa-phone-alt" style="font-size:10px; color:var(--primary-color)"></i> <span id="admin-phone-display">01700-000000</span></div>
                </div>
            </div>
            <br><br><br>
        </div>
        <div class="action-bar">
            <button class="btn btn-copy" onclick="copyProductDetails()"><i class="fas fa-copy"></i> Copy Details</button>
            <button class="btn btn-buy" onclick="openOrderModal()"><i class="fas fa-paper-plane"></i> Order Now</button>
        </div>
    </div>

    <!-- VIEW: MY ORDERS -->
    <div id="view-orders" class="view-section hide fade-in">
        <div class="page-header">My Orders</div>
        <div class="order-list" id="order-list-container">
            <p style="text-align:center; color:#999; margin-top:20px;">Loading orders...</p>
        </div>
    </div>

    <!-- VIEW: WALLET -->
    <div id="view-wallet" class="view-section hide fade-in">
        <div class="wallet-header">
            <div style="font-size: 14px; opacity: 0.9;">Available Balance</div>
            <div class="w-balance" id="wallet-balance">à§³0</div>
        </div>
        <div class="stats-grid">
            <div class="stat-box"><span class="sb-val" style="color:var(--primary-color)" id="w-total-sell">à§³0</span><span class="sb-label">Total Sell</span></div>
            <div class="stat-box"><span class="sb-val" style="color:var(--accent-green)" id="w-total-profit">à§³0</span><span class="sb-label">Total Profit</span></div>
            <div class="stat-box"><span class="sb-val" id="w-received">à§³0</span><span class="sb-label">Received</span></div>
            <div class="stat-box"><span class="sb-val" style="color:orange" id="wallet-pending">à§³0</span><span class="sb-label">Pending</span></div>
        </div>
        <div class="withdraw-section">
            <button class="withdraw-btn" onclick="openWithdrawModal()"><i class="fas fa-money-check-alt"></i> Request Withdrawal</button>
        </div>
        <div class="history-section">
            <div class="h-title">Transaction History</div>
            <div id="history-container">
                 <p style="text-align:center; color:#999; margin-top:10px;">No transaction history.</p>
            </div>
        </div>
    </div>

    <!-- VIEW: PROFILE -->
    <div id="view-profile" class="view-section hide fade-in">
        <div class="profile-header">
            <div class="p-img-wrapper"><img src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=200" alt="User" class="p-img" id="profile-img"></div>
            <div class="p-name" id="profile-name">Loading...</div>
            <div class="p-rank" id="profile-rank-badge">Member</div>
        </div>
        <div class="p-menu">
            <div class="p-item" onclick="openEditProfile()"><i class="fas fa-user-edit"></i> <span>Edit Profile</span></div>
            <div class="p-item" onclick="openChangePassword()"><i class="fas fa-lock"></i> <span>Change Password</span></div>
            <div class="p-item" onclick="handleResellerLogout()"><i class="fas fa-sign-out-alt"></i> <span style="color:var(--primary-color)">Logout</span></div>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- PLACE/EDIT ORDER MODAL -->
    <div class="modal" id="placeOrderModal">
        <div class="modal-content">
            <i class="fas fa-times close-modal" onclick="closeModal('placeOrderModal')"></i>
            <div class="m-title" id="po-modal-title"><i class="fas fa-box" style="color:var(--primary-color)"></i> Order Details</div>
            <div style="background: #f1f2f6; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; display:flex; align-items:center; gap:10px;">
                <img id="po-thumb" src="" style="width:40px; height:40px; border-radius:5px; object-fit:cover;">
                <div>
                    <div style="font-weight: 600;" id="po-item-name">Product Name</div>
                    <div style="font-size:11px; color:#555;">Size: <span id="po-variant-display" style="font-weight:700"></span></div>
                    <div style="font-size:11px; color:#777;">Wholesale: à§³<span id="po-wholesale">0</span></div>
                </div>
            </div>
            <form onsubmit="event.preventDefault(); submitOrder();">
                <input type="hidden" id="po-edit-id" value="">
                <div class="input-group"><i class="fas fa-user input-icon"></i><input type="text" class="form-control" id="po-name" placeholder="Customer Name"></div>
                <div class="input-group"><i class="fas fa-phone-alt input-icon"></i><input type="tel" class="form-control" id="po-phone" placeholder="Phone Number (11 digits)"></div>
                <div class="input-group"><i class="fas fa-map-marker-alt input-icon"></i><input type="text" class="form-control" id="po-address" placeholder="Full Address"></div>
                <div class="form-label">Delivery Area (Required)</div>
                <div class="delivery-options">
                    <div class="d-opt" id="d-opt-in" onclick="selectDelivery('inside')"><i class="fas fa-city" style="font-size:20px; margin-bottom:5px;"></i><br><span style="font-size:12px">Inside Dhaka</span><br><span style="font-weight:700">à§³80</span><div class="check"><i class="fas fa-check-circle"></i></div></div>
                    <div class="d-opt" id="d-opt-out" onclick="selectDelivery('outside')"><i class="fas fa-truck" style="font-size:20px; margin-bottom:5px;"></i><br><span style="font-size:12px">Outside Dhaka</span><br><span style="font-weight:700">à§³130</span><div class="check"><i class="fas fa-check-circle"></i></div></div>
                </div>
                <div class="input-group"><i class="fas fa-tag input-icon"></i><input type="number" class="form-control" id="po-price" placeholder="Sale Price (Excluding Delivery)"></div>
                <div class="input-group">
                    <i class="fas fa-money-bill-wave input-icon"></i>
                    <select class="form-control" id="po-payment" style="padding-left:40px">
                        <option value="COD">Cash on Delivery (COD)</option>
                        <option value="Bkash">Bkash</option>
                        <option value="Nagad">Nagad</option>
                    </select>
                </div>
                <div style="font-size:12px; text-align:right; margin-bottom:15px; color:#555;"><div>Your Profit: <span id="po-profit" style="font-weight:700; color:var(--accent-green)">à§³0</span></div><div>Total Collectable: <span id="po-total" style="font-weight:700; color:var(--primary-color)">à§³0</span></div></div>
                <button type="submit" class="modal-btn" id="po-submit-btn">Confirm Order</button>
            </form>
        </div>
    </div>

    <!-- INVOICE PREVIEW MODAL -->
    <div class="modal" id="invoiceModal">
        <div class="modal-content" style="max-width: 500px;">
            <i class="fas fa-times close-modal" onclick="closeModal('invoiceModal')"></i>
            <div style="text-align: center; margin-bottom: 10px;">
                <h3 style="color: var(--secondary-color);">Invoice Preview</h3>
                <p style="font-size: 12px; color: #888;">Review invoice before downloading</p>
            </div>
            
            <div id="invoice-preview-area">
                <div class="inv-header">
                    <div>
                        <div class="inv-brand">GLITZY GIFTS</div>
                        <div class="inv-tagline">Premium Collection</div>
                    </div>
                    <div class="inv-title">INVOICE</div>
                </div>

                <div class="inv-grid">
                    <div class="inv-col">
                        <h4>Bill To:</h4>
                        <p id="inv-name">Customer Name</p>
                        <p id="inv-phone">01700-000000</p>
                        <p id="inv-addr">Customer Address</p>
                    </div>
                    <div class="inv-col" style="text-align: right;">
                        <h4>Details:</h4>
                        <p>Inv #: <span id="inv-id">1001</span></p>
                        <p>Date: <span id="inv-date">Jan 01, 2025</span></p>
                    </div>
                </div>

                <div class="inv-table-wrapper">
                    <table class="inv-table">
                        <thead>
                            <tr>
                                <th>Item Description</th>
                                <th style="text-align: right;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div id="inv-product" style="font-weight: 700;">Product Name</div>
                                    <div style="font-size: 10px; color: #777;">Variant: <span id="inv-variant">Standard</span></div>
                                    <div style="font-size: 10px; color: #777;">Qty: 1</div>
                                </td>
                                <td>à§³<span id="inv-price">0</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="inv-summary">
                    <div class="inv-sum-row"><span>Subtotal:</span> <span>à§³<span id="inv-subtotal">0</span></span></div>
                    <div class="inv-sum-row"><span>Delivery:</span> <span>à§³<span id="inv-delivery">0</span></span></div>
                    <div class="inv-sum-row inv-total"><span>Total:</span> <span>à§³<span id="inv-total">0</span></span></div>
                    <div id="inv-status-stamp" class="inv-status status-due">DUE</div>
                </div>

                <div class="inv-footer">
                    <p>Thank you for shopping with Glitzy Gifts!</p>
                    <p style="margin-top: 5px;">Hotline: <span id="inv-admin-phone">01700-000000</span> | fb.com/glitzygifts</p>
                </div>
            </div>

            <button class="modal-btn" onclick="downloadPDF()"><i class="fas fa-download"></i> Download PDF</button>
        </div>
    </div>

    <!-- WITHDRAW MODAL -->
    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <i class="fas fa-times close-modal" onclick="closeModal('withdrawModal')"></i>
            <div class="m-title"><i class="fas fa-university" style="color:var(--primary-color)"></i> Withdraw</div>
            <div class="input-group"><select class="form-control" id="w-method" onchange="updateWithdrawFields()" style="padding-left:14px;"><option value="bkash">Bkash (Personal)</option><option value="nagad">Nagad (Personal)</option><option value="bank">Bank Transfer</option></select></div>
            <div class="input-group"><i class="fas fa-coins input-icon"></i><input type="number" class="form-control" id="w-amount" placeholder="Enter Amount"></div>
            <div class="input-group"><i class="fas fa-address-card input-icon"></i><input type="text" class="form-control" id="w-account-input" placeholder="01XXX-XXXXXX"></div>
            <button class="modal-btn" onclick="submitWithdraw()">Confirm Withdraw</button>
        </div>
    </div>

    <!-- PROFILE MODAL -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <i class="fas fa-times close-modal" onclick="closeModal('editProfileModal')"></i>
            <div class="m-title"><i class="fas fa-user-edit" style="color:var(--primary-color)"></i> Edit Profile</div>
            <form onsubmit="event.preventDefault(); saveProfile();">
                <div class="input-group"><i class="fas fa-user input-icon"></i><input type="text" class="form-control" id="ep-name" placeholder="Full Name"></div>
                <div class="input-group"><i class="fas fa-store input-icon"></i><input type="text" class="form-control" id="ep-shop" placeholder="Shop/Business Name"></div>
                <div class="input-group"><i class="fas fa-phone input-icon"></i><input type="tel" class="form-control" id="ep-phone" placeholder="Phone Number"></div>
                <button type="submit" class="modal-btn">Save Changes</button>
            </form>
        </div>
    </div>

    <div id="toast">Notification Message</div>

    <nav class="bottom-nav">
        <div class="nav-item active" id="nav-home" onclick="switchView('view-home', 'nav-home')"><i class="fas fa-store"></i> <span>Home</span></div>
        <div class="nav-item" id="nav-orders" onclick="switchView('view-orders', 'nav-orders')"><i class="fas fa-box-open"></i> <span>Orders</span></div>
        <div class="nav-item" id="nav-wallet" onclick="switchView('view-wallet', 'nav-wallet')"><i class="fas fa-wallet"></i> <span>Wallet</span></div>
        <div class="nav-item" id="nav-profile" onclick="switchView('view-profile', 'nav-profile')"><i class="fas fa-user-circle"></i> <span>Profile</span></div>
    </nav>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBmZDrv-oregwk_u5v_IEOGnwuZcLKKXkE",
            authDomain: "glitzy-gift.firebaseapp.com",
            databaseURL: "https://glitzy-gift-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "glitzy-gift",
            storageBucket: "glitzy-gift.firebasestorage.app",
            messagingSenderId: "186131317796",
            appId: "1:186131317796:web:7c48a2224a1c8b74a2c4b1",
            measurementId: "G-X3PERVEMMX"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Global Variables
        let products = [];
        let orders = [];
        let withdrawHistory = [];
        let userProfile = { name: "Reseller", shop: "", phone: "" };
        let adminInfo = { name: "Support", phone: "01700-000000" };
        let currentProduct = {};
        let deliveryCost = 0;
        let currentUser = null;
        let wallet = { balance: 0, pending: 0, received: 0, totalSell: 0, totalProfit: 0 };
        let currentInvoiceOrder = null;

        // --- AUTH & INIT ---
        window.onload = function() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadProfile();
                    loadProducts();
                    loadOrders();
                    loadWithdrawals();
                    loadAdminSettings();
                } else {
                    window.location.href = 'rslogin.html';
                }
            });
            document.getElementById('po-price').addEventListener('input', calculateTotals);
        }

        function handleResellerLogout() {
            if(confirm("Are you sure you want to logout?")) {
                auth.signOut().then(() => {
                    localStorage.removeItem('isResellerLoggedIn');
                    window.location.href = 'rslogin.html';
                });
            }
        }

        // --- DATA LOADERS (READ) ---
        function loadAdminSettings() {
            db.ref('admin_settings').on('value', snapshot => {
                const data = snapshot.val();
                if(data) {
                    adminInfo.name = data.name || "Support";
                    adminInfo.phone = data.phone || "01700-000000";
                    document.getElementById('admin-name-display').innerText = adminInfo.name;
                    document.getElementById('admin-phone-display').innerText = adminInfo.phone;
                    document.getElementById('inv-admin-phone').innerText = adminInfo.phone;
                }
            });
        }

        // --- FIXED FUNCTION TO HANDLE DATA PROPERLY ---
        function loadProducts() {
            db.ref('reseller_products').on('value', snapshot => {
                const data = snapshot.val();
                products = data ? Object.keys(data).map(key => {
                    let p = data[key];

                    // FIX 1: Robustly handle 'sizes' data
                    // This will correctly process comma-separated sizes, handle empty strings, and default to 'Free Size' if needed.
                    let parsedSizes = ['Free Size'];
                    if (p.sizes && typeof p.sizes === 'string' && p.sizes.trim() !== '') {
                        const tempSizes = p.sizes.split(',').map(s => s.trim()).filter(Boolean); // Cleans up data
                        if (tempSizes.length > 0) {
                            parsedSizes = tempSizes;
                        }
                    }

                    // FIX 2: Robustly handle 'description' data
                    // This ensures a default message is shown if the description is empty or missing.
                    const parsedDesc = (p.desc && p.desc.trim()) ? p.desc : "No description available.";

                    return {
                        dbKey: key,
                        id: p.id,
                        name: p.name,
                        wholesale: parseInt(p.buy) || 0,
                        rrp: parseInt(p.sell) || 0,
                        images: p.img ? [p.img] : ['https://via.placeholder.com/200'], // Fallback image
                        stock: parseInt(p.stock || 0),
                        desc: parsedDesc,
                        sizes: parsedSizes
                    };
                }) : [];
                renderProducts();
            });
        }


        function loadProfile() {
            db.ref('resellers/' + currentUser.uid).on('value', snapshot => {
                const data = snapshot.val();
                if(data) {
                    userProfile = data;
                    document.getElementById('profile-name').innerText = userProfile.name;
                }
            });
        }

        function loadOrders() {
            db.ref('reseller_orders').on('value', snapshot => {
                const data = snapshot.val();
                orders = [];
                if(data) {
                    Object.keys(data).forEach(key => {
                        let o = data[key];
                        if(o.rUid === currentUser.uid) {
                            o.dbKey = key;
                            orders.push(o);
                        }
                    });
                }
                orders.reverse(); 
                renderOrders();
                calculateWallet();
            });
        }

        function loadWithdrawals() {
            db.ref('withdrawals').on('value', snapshot => {
                const data = snapshot.val();
                withdrawHistory = data ? Object.values(data).filter(w => w.uid === currentUser.uid) : [];
                withdrawHistory.reverse();
                renderHistory();
                calculateWallet();
            });
        }

        // --- WALLET & RANK LOGIC ---
        function calculateWallet() {
            let totalProfit = 0, totalSell = 0, pendingWith = 0, paidWith = 0, deliveredCount = 0;
            orders.forEach(o => {
                if(o.status !== 'Cancelled') totalSell += parseFloat(o.total);
                if (o.status === 'Delivered' || o.status === 'Paid') {
                    totalProfit += parseFloat(o.profit);
                    if(o.status === 'Delivered') deliveredCount++;
                }
            });
            withdrawHistory.forEach(w => {
                if(w.status === 'Pending') pendingWith += parseFloat(w.amount);
                if(w.status === 'Paid') paidWith += parseFloat(w.amount);
            });
            const available = totalProfit - (pendingWith + paidWith);
            document.getElementById('wallet-balance').innerText = "à§³" + available;
            document.getElementById('header-balance').innerText = "à§³" + available;
            document.getElementById('w-total-sell').innerText = "à§³" + totalSell;
            document.getElementById('w-total-profit').innerText = "à§³" + totalProfit;
            document.getElementById('w-received').innerText = "à§³" + paidWith;
            document.getElementById('wallet-pending').innerText = "à§³" + pendingWith;
            document.getElementById('ds-completed').innerText = orders.filter(o => o.status === 'Delivered').length;
            document.getElementById('ds-cancelled').innerText = orders.filter(o => o.status === 'Cancelled').length;
            document.getElementById('ds-sell').innerText = "à§³" + totalSell;
            let rank = "Member";
            if(deliveredCount >= 30) rank = "VIP Member";
            else if(deliveredCount >= 20) rank = "Diamond Member";
            else if(deliveredCount >= 10) rank = "Platinum Member";
            document.getElementById('ds-rank').innerText = rank;
            document.getElementById('profile-rank-badge').innerText = rank;
            wallet.balance = available;
        }

        // --- UI RENDER FUNCTIONS ---
        function switchView(viewId, navId) { document.querySelectorAll('.view-section').forEach(el => el.classList.add('hide')); const target = document.getElementById(viewId); target.classList.remove('hide'); target.classList.add('fade-in'); if(navId) { document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); document.getElementById(navId).classList.add('active'); } window.scrollTo(0,0); }
        
        function renderProducts() { 
            const grid = document.getElementById('product-grid'); 
            if(products.length === 0) { grid.innerHTML = "<p>No products available.</p>"; return; }
            grid.innerHTML = products.map(p => { 
                const estimatedProfit = p.rrp - p.wholesale; 
                let stockClass = p.stock > 5 ? 'in-stock' : (p.stock > 0 ? 'low-stock' : 'out-stock');
                let stockText = p.stock > 0 ? `In Stock: ${p.stock}` : 'Out of Stock';
                return ` <div class="r-card" onclick="openProductDetails('${p.id}')"> <div class="r-img-container"> <img src="${p.images[0]}" alt="${p.name}"> <div class="profit-badge">Profit ~à§³${estimatedProfit}</div> <div class="stock-badge ${stockClass}">${stockText}</div> </div> <div class="r-info"> <div class="r-title">${p.name}</div> <div class="price-row"> <span class="wholesale">à§³${p.wholesale}</span> <span class="rrp">à§³${p.rrp}</span> </div> </div> </div>`; 
            }).join(''); 
        }
        
        function openProductDetails(pid) { 
            const p = products.find(x => x.id == pid); 
            if(!p) return; 
            currentProduct = p; 
            document.getElementById('d-main-img').src = p.images[0]; 
            document.getElementById('d-thumbs').innerHTML = p.images.map((img, index) => ` <div class="thumb-item ${index===0?'active':''}" onclick="changeImage('${img}', this)"> <img src="${img}"> </div> `).join(''); 
            document.getElementById('d-name').innerText = p.name; 
            document.getElementById('d-sku').innerText = "SKU-"+p.id; 
            document.getElementById('d-wholesale').innerText = "à§³" + p.wholesale; 
            document.getElementById('d-rrp').innerText = "à§³" + p.rrp; 
            document.getElementById('d-desc').innerText = p.desc;
            const stockDisplay = document.getElementById('d-stock-count');
            stockDisplay.innerText = p.stock;
            if(p.stock < 1) { stockDisplay.parentElement.style.borderLeftColor = "#ff4757"; stockDisplay.parentElement.style.color = "#c0392b"; stockDisplay.innerText = "0 (Out of Stock)"; } else { stockDisplay.parentElement.style.borderLeftColor = "#2ecc71"; stockDisplay.parentElement.style.color = "#1b5e20"; }
            document.getElementById('d-variant-select').innerHTML = p.sizes.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('admin-name-display').innerText = adminInfo.name;
            document.getElementById('admin-phone-display').innerText = adminInfo.phone;
            switchView('view-details', null); 
        }
        
        function changeImage(src, el) { document.getElementById('d-main-img').src = src; document.querySelectorAll('.thumb-item').forEach(t => t.classList.remove('active')); el.classList.add('active'); }
        function downloadImage() { const link = document.createElement('a'); link.href = document.getElementById('d-main-img').src; link.download = `Product_${currentProduct.id}.jpg`; link.target = '_blank'; document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast("Downloading Image..."); }
        
        function copyProductDetails() { const variant = document.getElementById('d-variant-select').value; const txt = `ðŸŒ¸ New Collection ðŸŒ¸\n\nðŸ“¦ Product: ${currentProduct.name}\nðŸ“ Size: ${variant}\nðŸ’° Price: à§³${currentProduct.rrp}\n\nðŸ“ Details:\n${currentProduct.desc}\n\nâœ… High Quality\nâœ… Home Delivery Available\n\nðŸ“© Message to order now!`; navigator.clipboard.writeText(txt).then(() => { showToast("Details & Description copied!"); }); }
        
        // --- ORDER PLACEMENT & EDITING ---
        function openOrderModal(isEdit = false, orderData = null) {
            document.getElementById('placeOrderModal').style.display = 'flex';
            const selectedVariant = isEdit ? orderData.variant : document.getElementById('d-variant-select').value;
            if(isEdit && orderData) {
                document.getElementById('po-modal-title').innerHTML = '<i class="fas fa-edit" style="color:var(--primary-color)"></i> Edit Order';
                document.getElementById('po-edit-id').value = orderData.dbKey;
                document.getElementById('po-item-name').innerText = orderData.product;
                document.getElementById('po-variant-display').innerText = orderData.variant || "Standard";
                document.getElementById('po-wholesale').innerText = orderData.sellPrice - orderData.profit;
                document.getElementById('po-thumb').src = "https://via.placeholder.com/50"; 
                document.getElementById('po-name').value = orderData.cName;
                document.getElementById('po-phone').value = orderData.cPhone;
                document.getElementById('po-address').value = orderData.cAddress;
                document.getElementById('po-price').value = orderData.sellPrice;
                document.getElementById('po-payment').value = orderData.payment || 'COD';
                document.getElementById('po-submit-btn').innerText = "Update Order";
                if(orderData.delivery === 80) selectDelivery('inside'); else selectDelivery('outside');
            } else {
                if(currentProduct.stock < 1) { closeModal('placeOrderModal'); alert("This product is currently Out of Stock!"); return; }
                document.getElementById('po-modal-title').innerHTML = '<i class="fas fa-box" style="color:var(--primary-color)"></i> Order Details';
                document.getElementById('po-edit-id').value = ""; 
                document.getElementById('po-item-name').innerText = currentProduct.name;
                document.getElementById('po-variant-display').innerText = selectedVariant;
                document.getElementById('po-wholesale').innerText = currentProduct.wholesale;
                document.getElementById('po-thumb').src = currentProduct.images[0];
                document.getElementById('po-name').value = ''; document.getElementById('po-phone').value = ''; document.getElementById('po-address').value = '';
                document.getElementById('po-price').value = currentProduct.rrp;
                document.getElementById('po-payment').value = 'COD';
                document.getElementById('po-submit-btn').innerText = "Confirm Order";
                deliveryCost = 0;
                document.querySelectorAll('.d-opt').forEach(el => el.classList.remove('selected'));
                calculateTotals();
            }
        }
        
        function selectDelivery(type) { document.querySelectorAll('.d-opt').forEach(el => el.classList.remove('selected')); if(type === 'inside') { deliveryCost = 80; document.getElementById('d-opt-in').classList.add('selected'); } else { deliveryCost = 130; document.getElementById('d-opt-out').classList.add('selected'); } calculateTotals(); }
        function calculateTotals() { const sellPrice = parseFloat(document.getElementById('po-price').value) || 0; const wholesale = parseFloat(document.getElementById('po-wholesale').innerText.replace('à§³','')); const profit = sellPrice - wholesale; const totalCollectable = sellPrice + deliveryCost; const profitEl = document.getElementById('po-profit'); profitEl.innerText = "à§³" + profit; profitEl.style.color = profit >= 0 ? "var(--accent-green)" : "red"; document.getElementById('po-total').innerText = "à§³" + totalCollectable; }
        function submitOrder() { 
            const name = document.getElementById('po-name').value, phone = document.getElementById('po-phone').value, address = document.getElementById('po-address').value, price = document.getElementById('po-price').value; 
            if(!name || !phone || !address || !price) { showToast("Please fill all text fields!"); return; } 
            if(deliveryCost === 0) { showToast("Please select Delivery Area!"); return; } 
            const sellPrice = parseFloat(price);
            const orderData = { rUid: currentUser.uid, rName: userProfile.name, cName: name, cPhone: phone, cAddress: address, product: document.getElementById('po-item-name').innerText, variant: document.getElementById('po-variant-display').innerText, total: sellPrice + deliveryCost, profit: sellPrice - parseFloat(document.getElementById('po-wholesale').innerText.replace('à§³','')), status: "Pending", payment: document.getElementById('po-payment').value, sellPrice: sellPrice, delivery: deliveryCost, date: new Date().toDateString() };
            const editId = document.getElementById('po-edit-id').value;
            if(editId) {
                orderData.id = orders.find(o => o.dbKey === editId).id;
                const existingOrder = orders.find(o => o.dbKey === editId);
                if(existingOrder && existingOrder.productId) orderData.productId = existingOrder.productId;
                db.ref('reseller_orders/' + editId).update(orderData).then(() => { closeModal('placeOrderModal'); showToast("Order Updated!"); });
            } else {
                orderData.productId = currentProduct.dbKey;
                orderData.id = "ORD-" + Math.floor(1000 + Math.random() * 9000);
                const newStock = currentProduct.stock - 1;
                db.ref('reseller_products/' + currentProduct.dbKey).update({stock: newStock}).then(() => {
                    db.ref('reseller_orders').push(orderData).then(() => { closeModal('placeOrderModal'); showToast("Order Placed Successfully!"); openInvoiceModal(orderData); });
                }).catch(err => alert("Error updating stock: " + err.message));
            }
        }

        // --- ORDER ACTIONS (CANCEL / EDIT) ---
        function renderOrders() { 
            const container = document.getElementById('order-list-container'); 
            if(orders.length === 0) { container.innerHTML = '<p style="text-align:center; padding:20px; color:#888">No orders placed yet.</p>'; return; }
            container.innerHTML = orders.map(o => {
                const actionButtons = o.status === 'Pending' ? `<div class="order-actions"><button class="act-btn btn-invoice" onclick="event.stopPropagation(); openInvoiceModalFromList('${o.dbKey}')"><i class="fas fa-file-invoice"></i> Invoice</button><button class="act-btn btn-edit" onclick="event.stopPropagation(); editOrder('${o.dbKey}')"><i class="fas fa-edit"></i> Edit</button><button class="act-btn btn-cancel" onclick="event.stopPropagation(); cancelOrder('${o.dbKey}')"><i class="fas fa-trash-alt"></i> Cancel</button></div>` : `<div class="order-actions"><button class="act-btn btn-invoice" onclick="event.stopPropagation(); openInvoiceModalFromList('${o.dbKey}')"><i class="fas fa-file-invoice"></i> Invoice</button></div>`;
                return ` <div class="order-card ${o.status.toLowerCase()}"><div class="order-card-content"><div> <div class="o-id">#${o.id}</div> <div class="o-date">${o.date}</div> <div style="font-size:12px; color:#555;">${o.product} (${o.variant || 'Std'})</div> </div> <span class="o-status st-${o.status.toLowerCase()}">${o.status}</span> </div>${actionButtons}</div> `;
            }).join(''); 
        }

        function cancelOrder(key) {
            const order = orders.find(x => x.dbKey === key);
            if(!order) return;
            if(confirm("Are you sure you want to Cancel this order?")) {
                db.ref('reseller_orders/' + key).update({status: 'Cancelled', profit: 0}).then(() => {
                    if(order.productId) { db.ref('reseller_products/' + order.productId + '/stock').transaction((currentStock) => (currentStock || 0) + 1); }
                    showToast("Order Cancelled & Stock Renewed");
                });
            }
        }
        function editOrder(key) { const o = orders.find(x => x.dbKey === key); if(o) openOrderModal(true, o); }
        
        // --- INVOICE GENERATION & PDF ---
        function openInvoiceModalFromList(key) { const o = orders.find(x => x.dbKey === key); if(o) openInvoiceModal(o); }
        function openInvoiceModal(o) {
            currentInvoiceOrder = o;
            document.getElementById('inv-name').innerText = o.cName; document.getElementById('inv-phone').innerText = o.cPhone; document.getElementById('inv-addr').innerText = o.cAddress;
            document.getElementById('inv-id').innerText = o.id.replace("ORD-", ""); document.getElementById('inv-date').innerText = o.date;
            document.getElementById('inv-product').innerText = o.product; document.getElementById('inv-variant').innerText = o.variant || "Standard";
            document.getElementById('inv-price').innerText = o.sellPrice; document.getElementById('inv-subtotal').innerText = o.sellPrice;
            document.getElementById('inv-delivery').innerText = o.delivery; document.getElementById('inv-total').innerText = o.total;
            const stamp = document.getElementById('inv-status-stamp');
            if(o.payment === 'COD' || !o.payment) { stamp.innerText = "UNPAID / DUE"; stamp.className = "inv-status status-due"; } else { stamp.innerText = "PAID VIA " + o.payment.toUpperCase(); stamp.className = "inv-status status-paid"; }
            document.getElementById('invoiceModal').style.display = 'flex';
        }

        function downloadPDF() {
            const element = document.getElementById('invoice-preview-area');
            const opt = { margin: 0, filename: `Invoice_${currentInvoiceOrder.id}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            showToast("Generating PDF...");
            html2pdf().set(opt).from(element).save().then(() => { showToast("Download Started!"); });
        }

        // --- WITHDRAW (WRITE) ---
        function openWithdrawModal() { document.getElementById('withdrawModal').style.display = 'flex'; updateWithdrawFields(); }
        function updateWithdrawFields() { const method = document.getElementById('w-method').value, input = document.getElementById('w-account-input'); if(method === 'bkash') input.placeholder = "Bkash Number (01XXX...)"; else if(method === 'nagad') input.placeholder = "Nagad Number (01XXX...)"; else input.placeholder = "Bank Name, A/C No"; }
        function submitWithdraw() { 
            const amount = parseFloat(document.getElementById('w-amount').value), account = document.getElementById('w-account-input').value, method = document.getElementById('w-method').value; 
            if(!amount || !account) { showToast("Please enter amount and account info!"); return; } 
            if(amount > wallet.balance) { showToast("Insufficient Balance!"); return; } 
            const newTx = { id: Math.floor(100000 + Math.random() * 900000), uid: currentUser.uid, name: userProfile.name, phone: userProfile.phone, method: method.charAt(0).toUpperCase() + method.slice(1), amount: amount, date: new Date().toDateString(), status: "Pending" };
            db.ref('withdrawals').push(newTx).then(() => { closeModal('withdrawModal'); showToast("Withdrawal Request Submitted!"); });
        }
        function renderHistory() { 
            const container = document.getElementById('history-container'); 
            if(withdrawHistory.length === 0) { container.innerHTML = '<p style="text-align:center; padding:10px; color:#999">No transaction history.</p>'; return; }
            container.innerHTML = withdrawHistory.map(h => { 
                let color = h.status === 'Paid' ? 'green' : (h.status === 'Pending' ? '#e67e22' : 'red'); 
                let bg = h.status === 'Paid' ? '#d4edda' : (h.status === 'Pending' ? '#fff3cd' : '#ffe0e3'); 
                return ` <div class="history-card"> <div class="h-left"> <div class="h-type">Withdrawal - ${h.method}</div> <div class="h-date">${h.date} | ID: ${h.id}</div> </div> <div style="text-align:right"> <div class="h-amount" style="color:var(--primary-color)">-à§³${h.amount}</div> <span class="h-status" style="background:${bg}; color:${color}">${h.status}</span> </div> </div>`; 
            }).join(''); 
        }

        // --- PROFILE EDIT ---
        function openEditProfile() { document.getElementById('ep-name').value = userProfile.name; document.getElementById('ep-shop').value = userProfile.shopName || ''; document.getElementById('ep-phone').value = userProfile.phone; document.getElementById('editProfileModal').style.display = 'flex'; }
        function saveProfile() { 
            const updates = { name: document.getElementById('ep-name').value, shopName: document.getElementById('ep-shop').value, phone: document.getElementById('ep-phone').value };
            db.ref('resellers/' + currentUser.uid).update(updates).then(() => { closeModal('editProfileModal'); showToast("Profile Updated Successfully!"); });
        }
        function openChangePassword() { /* For Future Use */ alert("This feature is not yet implemented."); }
        
        // Modal & Utils
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000); }
    </script>
</body>
</html>